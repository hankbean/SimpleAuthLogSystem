@page
@model SimpleAuthLog.Pages.UsersModel
@{
    ViewData["Title"] = "使用者列表";
}

<h1>@ViewData["Title"]</h1>

@if (TempData["SuccessMessage"] != null)
{
    <div class="alert alert-success">@TempData["SuccessMessage"]</div>
}
@if (TempData["ErrorMessage"] != null)
{
    <div class="alert alert-danger">@TempData["ErrorMessage"]</div>
}

<p>以下是目前系統中所有的使用者。您可以進行編輯或刪除操作。</p>

<table class="table table-striped">
    <thead>
        <tr>
            <th>ID</th>
            <th>使用者名稱</th>
            <th>權限 (Roles)</th>
            <th style="width: 20%;">操作</th>
        </tr>
    </thead>
    <tbody>
        @foreach (var item in Model.UserListWithRoles)
        {
            <tr>
                <td>@item.User.Id</td>
                <td>@item.User.UserName</td>
                <td>
                    @if (item.Roles.Any())
                    {
                        foreach (var roleName in item.Roles)
                        {
                            <span class"badge bg-info me-1" style="font-size: 0.9em; padding-left: 10px; padding-right: 2px; vertical-align: middle;">
                                @roleName

                                <form method="post" asp-page-handler="RemoveRole"
                                      asp-route-userid="@item.User.Id"
                                      asp-route-rolename="@roleName"
                                      style="display: inline;"
                                      onsubmit="return confirm('您確定要從 [@item.User.UserName] 身上移除 [@roleName] 角色嗎？');">

                                    <button type="submit" class="btn-close"
                                            aria-label="Remove"
                                            style="font-size: 0.6em; vertical-align: middle; padding: 0.5rem;"></button>
                                </form>
                            </span>
                        }
                    }
                    else
                    {
                        <span class="text-muted">-- 無 --</span>
                    }
                </td>
                <td>
                    <button type="button" class="btn btn-sm btn-primary" data-bs-toggle="modal" data-bs-target="#editUserModal"
                            data-userid="@item.User.Id" data-username="@item.User.UserName">
                        編輯
                    </button>

                    <form method="post" asp-page-handler="Delete" asp-route-id="@item.User.Id" style="display:inline;" onsubmit="return confirm('您確定要刪除這位使用者嗎？');">
                        <button type="submit" class="btn btn-sm btn-danger">刪除</button>
                    </form>

                    <button type="button" class="btn btn-sm btn-info ms-1"
                            data-bs-toggle="modal" data-bs-target="#assignRoleModal"
                            data-userid="@item.User.Id" data-username="@item.User.UserName">
                        指派角色
                    </button>
                </td>
            </tr>
        }
    </tbody>
</table>

<div class="modal fade" id="editUserModal" tabindex="-1" aria-labelledby="editUserModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <form method="post" asp-page-handler="Update">
                <div class="modal-header">
                    <h5 class="modal-title" id="editUserModalLabel">編輯使用者</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <input type="hidden" asp-for="EditUserId" id="edit-userid" />

                    <div class="mb-3">
                        <label asp-for="EditUser.Username" class="form-label">新使用者名稱</label>
                        <input asp-for="EditUser.Username" class="form-control" id="edit-username" />
                    </div>
                    <div class="mb-3">
                        <label asp-for="EditUser.Password" class="form-label">新密碼 (留白表示不更改)</label>
                        <input asp-for="EditUser.Password" type="password" class="form-control" placeholder="留白表示不更改" />
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                    <button type="submit" class="btn btn-primary">儲存變更</button>
                </div>
            </form>
        </div>
    </div>
</div>

<div class="modal fade" id="assignRoleModal" tabindex="-1" aria-labelledby="assignRoleModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <form method="post" asp-page-handler="AssignRole">
                <div class="modal-header"> <h5 class="modal-title" id="assignRoleModalLabel">指派角色</h5> <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button> </div> <div class="modal-body">
                    <input type="hidden" asp-for="AssignRoleUserId" id="assign-userid" />

                    <div class="mb-3">
                        <label>即將為使用者：<strong id="assign-username"></strong></label>
                    </div>

                    <div class="mb-3">
                        <label asp-for="AssignRoleName" class="form-label">選擇一個角色</label>
                        <select asp-for="AssignRoleName" class="form-select">
                            <option value="">-- 請選擇 --</option>
                            @foreach (var role in Model.RoleList)
                            {
                                <option value="@role.Name">@role.Name</option>
                            }
                        </select>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                    <button type="submit" class="btn btn-primary">確認指派</button>
                </div>
            </form>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        var editUserModal = document.getElementById('editUserModal');
        editUserModal.addEventListener('show.bs.modal', function (event) {
            var button = event.relatedTarget;

            var userId = button.getAttribute('data-userid');
            var username = button.getAttribute('data-username');

            var modalTitle = editUserModal.querySelector('.modal-title');
            var userIdInput = editUserModal.querySelector('#edit-userid');
            var usernameInput = editUserModal.querySelector('#edit-username');

            modalTitle.textContent = '編輯使用者: ' + username + ' (ID: ' + userId + ')';
            userIdInput.value = userId;
            usernameInput.value = username;
        });

        var assignRoleModal = document.getElementById('assignRoleModal');
        assignRoleModal.addEventListener('show.bs.modal', function (event) {
            var button = event.relatedTarget;

            var userId = button.getAttribute('data-userid');
            var username = button.getAttribute('data-username');

            var modalTitle = assignRoleModal.querySelector('.modal-title');
            var userIdInput = assignRoleModal.querySelector('#assign-userid');
            var usernameLabel = assignRoleModal.querySelector('#assign-username');

            modalTitle.textContent = '指派角色給: ' + username;
            userIdInput.value = userId;
            usernameLabel.textContent = username;
        });
    </script>
}